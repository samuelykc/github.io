<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mölkky Scoresheet</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #FFFFFF;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #1E1E1E;
        }
        table, th, td {
            border: 1px solid #333333;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #2C2C2C;
        }
        input[type="number"] {
            width: 60px;
            background-color: #333333;
            color: #FFFFFF;
            border: 1px solid #555555;
            text-align: center;
        }
        input[type="text"] {
            background-color: #333333;
            color: #FFFFFF;
            border: 1px solid #555555;
        }
        button {
            background-color: #444444;
            color: #FFFFFF;
            border: 1px solid #555555;
            padding: 5px 10px;
            cursor: pointer;
        }
        button:hover {
            background-color: #555555;
        }

        .button-container {
            display: flex;
            width: 100%;
            margin-top: 8px;
        }
        button#removeTurnBtn {
            width: 80px;
            margin-right: 6px;
        }
        button#addTurnBtn {
            flex-grow: 1;
        }

        /* Dark mode styles */
        body.dark-mode {
            background-color: #121212;
            color: #FFFFFF;
        }
        body.dark-mode table {
            background-color: #1E1E1E;
        }
        body.dark-mode th {
            background-color: #2C2C2C;
        }
        body.dark-mode input {
            background-color: #333333;
            color: #FFFFFF;
        }
        body.dark-mode button {
            background-color: #444444;
            color: #FFFFFF;
            border: 1px solid #555555;
        }
        body.dark-mode button:hover {
            background-color: #555555;
        }

        /* Light mode styles */
        body.light-mode {
            background-color: #FFFFFF;
            color: #000000;
        }
        body.light-mode table {
            background-color: #F9F9F9;
        }
        body.light-mode th {
            background-color: #DDDDDD;
        }
        body.light-mode input {
            background-color: #FFFFFF;
            color: #000000;
        }
        body.light-mode button {
            background-color: #EEEEEE;
            color: #000000;
            border: 1px solid #CCCCCC;
        }
        body.light-mode button:hover {
            background-color: #DDDDDD;
        }
    </style>
    <script>
        const players = [];
        let turnCount = 0;

        document.addEventListener('DOMContentLoaded', () => {
            loadFromQueryString();
        });

        function addPlayer() {
            const playerName = document.getElementById('playerName').value;
            const playerTeam = parseInt(document.getElementById('playerTeam').value);
            if (playerName && !isNaN(playerTeam)) {
                const initialScores = new Array(turnCount).fill(0);
                players.push({ name: playerName, team: playerTeam, scores: initialScores });
                document.getElementById('playerName').value = '';
                updateScoresTable();
                updateQueryString();
            }
        }

        function removeTurnScores() {
            turnCount--;
            players.forEach((player) => {
                if(player.scores.length > turnCount) player.scores = player.scores.slice(0, turnCount);
            });
            updateScoresTable();
            updateQueryString();
        }
        function addTurnScores() {
            turnCount++;
            players.forEach((player) => {
                player.scores.push(0);
            });
            updateScoresTable();
            updateQueryString();
        }

        function getTotalScore(turnScores, turnIndex) {
            const targetScore = parseInt(document.getElementById('targetScore').value);
            const resetScore = parseInt(document.getElementById('resetScore').value);
            const consecutiveMissDropout = document.getElementById('consecutiveMissDropout').checked;

            return turnScores.slice(0, turnIndex + 1).reduce((total, score, index, scores) => {
                let turnSum = total + score;

                // Check for brust
                if (turnSum > targetScore) return resetScore;

                // Check for three consecutive zeros
                if (index >= 2 &&
                    scores[index] === 0 &&
                    scores[index - 1] === 0 &&
                    scores[index - 2] === 0
                ) {
                    // Set all future scores to 0
                    if(consecutiveMissDropout) turnScores.fill(0, index + 1);

                    return 0;
                }

                return turnSum;
            }, 0);
        }
        function getPlayerTotalScore(player, turnIndex) { return getTotalScore(player.scores, turnIndex); }
        function getTeamTotalScore(teamScores, turnIndex) { return getTotalScore(teamScores, turnIndex); }

        function getTeamScores(team, turnIndex) {
            const teamScores = [];

            // Retrieve scores for the specified team
            players.filter(player => player.team === team) // Filter players by the given team
                   .forEach(player => player.scores.forEach((score, index) => // Get scores for that turn
                    {
                        if(teamScores[index]) teamScores[index] += score;
                        else teamScores[index] = score;
                    }));

            console.log(players)
            console.log(players.filter(player => player.team === team))
            console.log(teamScores)

            return teamScores;
        }

        function updateScoresTable() {
            const scoresTableHead = document.getElementById('scoresTable').querySelector('thead tr');
            const scoresTableBody = document.getElementById('scoresTable').querySelector('tbody');
            // Reset table
            scoresTableHead.innerHTML = '<th>Turn</th>';
            scoresTableBody.innerHTML = '';

            // Sort players by team number
            players.sort((a, b) => a.team - b.team);

            // Add headers with player names and team numbers as input fields
            let i = 0;
            players.forEach((player, index) => {
                const th = document.createElement('th');
                th.innerHTML = `
                   <div>
                       Player Name: <input type="text" value="${player.name}" onchange="updatePlayerName(${index}, this.value)">
                       Team: <input type="number" value="${player.team}" min="0" onchange="updatePlayerTeam(${index}, this.value)">
                   </div>
                `;
                scoresTableHead.appendChild(th);

                let isLastInTeam = (i+1)>=players.length || player.team != players[i+1].team;
                if(isLastInTeam)
                {
                    const totalTh = document.createElement('th');
                    totalTh.textContent = "Total";
                    scoresTableHead.appendChild(totalTh);
                }
                i++;
            });

            // Compute each team's scores on each round
            let allTeamScores = {};
            players.forEach((player, index) => { if(!allTeamScores[player.team]) allTeamScores[player.team]=getTeamScores(player.team); });

            // Add turn rows with scores
            for (let turnIndex = 0; turnIndex < turnCount; turnIndex++) {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${turnIndex + 1}</td>`;

                players.forEach((player, playerIndex) =>
                {
                    const scoreTd = document.createElement('td');
                    scoreTd.innerHTML = `
                        <input type="number" id="score_${turnIndex}_${playerIndex}" value="${player.scores[turnIndex]}" min="0" max="12" onchange="updateScore(${turnIndex}, ${playerIndex})">
                    `;
                    row.appendChild(scoreTd);

                    let isLastInTeam = (playerIndex+1)>=players.length || player.team != players[playerIndex+1].team;
                    if(isLastInTeam)
                    {
                        const totalTd = document.createElement('td');
                        // totalTd.textContent = getPlayerTotalScore(player, turnIndex);
                        totalTd.textContent = getTeamTotalScore(allTeamScores[player.team], turnIndex);
                        row.appendChild(totalTd);
                    }
                });
                scoresTableBody.appendChild(row);
            }
        }

        function updatePlayerName(playerIndex, newName) {
            players[playerIndex].name = newName;
            updateScoresTable();
            updateQueryString();
        }

        function updatePlayerTeam(playerIndex, newTeam) {
            players[playerIndex].team = parseInt(newTeam);
            updateScoresTable();
            updateQueryString();
        }

        function updateScore(turnIndex, playerIndex) {
            const scoreInput = document.getElementById(`score_${turnIndex}_${playerIndex}`);
            let score = parseInt(scoreInput.value);

            players[playerIndex].scores[turnIndex] = isNaN(score) ? 0 : score;
            updateScoresTable();
            updateQueryString();
        }

        function updateQueryString() {
            const params = new URLSearchParams();
            
            params.set('targetScore', document.getElementById('targetScore').value);
            params.set('resetScore', document.getElementById('resetScore').value);
            params.set('consecutiveMissDropout', document.getElementById('consecutiveMissDropout').checked);

            players.forEach((player, index) => {
                params.set(`player_${index}`, player.name);
                params.set(`team_${index}`, player.team);
                player.scores.forEach((score, turnIndex) => {
                    params.set(`score_${index}_${turnIndex}`, score);
                });
            });

            history.replaceState(null, '', '?' + params.toString());
        }

        function loadFromQueryString() {
            const params = new URLSearchParams(window.location.search);

            if (params.has('targetScore')) document.getElementById('targetScore').value = params.get('targetScore');
            if (params.has('resetScore')) document.getElementById('resetScore').value = params.get('resetScore');
            document.getElementById('consecutiveMissDropout').checked = params.has('consecutiveMissDropout')? params.get('consecutiveMissDropout')==='true': true;

            let playerIndex = 0;
            while (params.has(`player_${playerIndex}`)) {
                const playerName = params.get(`player_${playerIndex}`);
                const playerTeam = parseInt(params.get(`team_${playerIndex}`));
                const initialScores = [];
                
                let turnIndex = 0;
                while (params.has(`score_${playerIndex}_${turnIndex}`)) {
                    initialScores.push(parseInt(params.get(`score_${playerIndex}_${turnIndex}`)));
                    turnIndex++;
                }

                players.push({ name: playerName, team: playerTeam, scores: initialScores });
                playerIndex++;
            }

            //find turnCount
            for (let i = 0; i < players.length; i++) {
                if(players[i].scores.length > turnCount) turnCount = players[i].scores.length;
            }

            updateScoresTable();
        }

        function toggleColorMode() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            body.classList.toggle('light-mode');
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href);
        }

        // Initialize with dark mode
        document.addEventListener('DOMContentLoaded', () => {
            document.body.classList.add('dark-mode');
        });
    </script>
</head>
<body>
    <h1>Mölkky Scoresheet</h1>

    <div>
        <button onclick="toggleColorMode()">Toggle Dark Mode</button>
        <button onclick="copyLink()">Copy Link</button>
    </div>
    <br/>

    <div>
        <label for="targetScore">Target score:</label>
        <input type="number" id="targetScore" value="50" onchange="updateScoresTable(); updateQueryString()">
    </div>
    <div>
        <label for="resetScore">Reset Score:</label>
        <input type="number" id="resetScore" value="25" onchange="updateScoresTable(); updateQueryString()">
    </div>
    <div>
        <label for="consecutiveMissDropout">3 Miss Dropout:</label>
        <input type="checkbox" id="consecutiveMissDropout" onchange="updateScoresTable(); updateQueryString()">
    </div>
    <br/>

    <div>
        <label for="playerName">Player Name:</label>
        <input type="text" id="playerName">
        <label for="playerTeam">Team:</label>
        <input type="number" id="playerTeam" min="0" value="1">
        <button onclick="addPlayer()">Add Player</button>
    </div>

    <table id="scoresTable">
        <thead>
            <tr>
                <th>Turn</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <div class="button-container">
        <button id="removeTurnBtn" onclick="removeTurnScores()">Remove Turn</button>
        <button id="addTurnBtn" onclick="addTurnScores()">Add Turn</button>
    </div>
    
</body>
</html>